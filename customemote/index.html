
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>データ受信テスト</title>
<style>
    .pic_frame {
      display: inline-block;
      text-align: center;
    }

    table {
      text-align: center;
    }
  </style>
<body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<div id="bttv">
</div>
<script type="text/javascript">

	get_text = document.location.search;
	get_text = get_text.substring(1,get_text.length);

	var bttv = false;
	var name;

	get_text = get_text.split("&").forEach(function(value) {
		var i = value.split("=")[0].length;
		var s1 = value.substring(0, i);
		var s2 = value.substring(i + 1);

		if(s1 === "bttv"){
			if(s2 === "true"){
				bttv = true;
			}else{
				bttv = false;
			}
		}
		if(s1 === "name"){
			name = s2;
		}
	});
	var twitchKey = "q6batx0epp608isickayubi39itsckt";
	var twitchAccept = "application/vnd.twitchtv.v5+json"
	var twitchKraken = 'https://api.twitch.tv/kraken'

	var elmBttv = document.getElementById("bttv");
	var elmBttvIMG = document.getElementById("bttvimg");
	var elmBttvTXT = document.getElementById("bttvtxt");

	$.ajaxSetup({
		headers: {
			'Accept': twitchAccept,
			'Client-ID': twitchKey 
		}
	});


	if(bttv){
		var midashi = document.createElement("h2");
		midashi.appendChild(document.createTextNode("そのチャンネル内で使えるエモート(BTTV)"));
		elmBttv.appendChild(midashi);

		var table2 = document.createElement("table");
		var tr3 = document.createElement("tr");
		var tr4 = document.createElement("tr");


		$.getJSON(twitchKraken + '/users?login=' + name, function (json) {
			var id = json.users[0]._id;
			$.getJSON('https://api.betterttv.net/3/cached/users/twitch/' + id, function (json2) {
				n = 0;
				json2.channelEmotes.forEach(function(value) {
					console.log(n);
					var img = document.createElement("img");
			        img.src = "https://cdn.betterttv.net/emote/" + value.id + "/1x";
			        img.width = 32;
			        img.height = 32;
					var text = document.createTextNode(value.code);
					if(n >= 3){
						table2.appendChild(tr3);
						table2.appendChild(tr4);
						tr3 = document.createElement("tr");
						tr4 = document.createElement("tr");
				    	n = 0;
				    }
					var td1 = document.createElement("td");
					td1.appendChild(img);
			       	tr3.appendChild(td1);

					var td2 = document.createElement("td");
					td2.appendChild(text);
			       	tr4.appendChild(td2);
			       	n++;
				});
				json2.sharedEmotes.forEach(function(value) {
					console.log(n);
					var img = document.createElement("img");
			        img.src = "https://cdn.betterttv.net/emote/" + value.id + "/1x";
			        img.width = 32;
			        img.height = 32;
					var text = document.createTextNode(value.code);
					if(n >= 3){
						table2.appendChild(tr3);
						table2.appendChild(tr4);
						tr3 = document.createElement("tr");
						tr4 = document.createElement("tr");
				    	n = 0;
				    }
					var td1 = document.createElement("td");
					td1.appendChild(img);
			       	tr3.appendChild(td1);

					var td2 = document.createElement("td");
					td2.appendChild(text);
			       	tr4.appendChild(td2);
			       	n++;
				});
			});
		});
		table2.appendChild(tr3);
		table2.appendChild(tr4);
		elmBttv.appendChild(table2);

		midashi = document.createElement("h2");
		midashi.appendChild(document.createTextNode("グローバル(BTTV)"));
		elmBttv.appendChild(midashi);
		var n = 0;
		var table = document.createElement("table");
		var tr1 = document.createElement("tr");
		var tr2 = document.createElement("tr");
		$.getJSON('https://api.betterttv.net/3/cached/emotes/global', function (json) {
			json.forEach(function(value) {
				var img = document.createElement("img");
		        img.src = "https://cdn.betterttv.net/emote/" + value.id + "/1x";
		        img.width = 32;
		        img.height = 32;
				var text = document.createTextNode(value.code);
				if(n >= 3){
					table.appendChild(tr1);
					table.appendChild(tr2);
					tr1 = document.createElement("tr");
					tr2 = document.createElement("tr");
			    	n = 0;
			    }
				var td1 = document.createElement("td");
				td1.appendChild(img);
		       	tr1.appendChild(td1);

				var td2 = document.createElement("td");
				td2.appendChild(text);
		       	tr2.appendChild(td2);

		       	n++;
			});
		});

		table.appendChild(tr1);
		table.appendChild(tr2);
		elmBttv.appendChild(table);

	}
	
</script>
</body>
</html>
